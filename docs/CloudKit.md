That are CloudKit capabilities to our app so that it can synchronize all CRUD operations, that's the create, read, update, and delete operations amongst all of our devices that are signed into the same iCloud account. I love getting your feedback so tap the thumbs up button if you enjoyed this video and leave a comment below. Make sure you subscribe to the video and ring that bell to get notifications of new videos. And if you want to support my work, you can buy me a coffee. If you are staying with me on the Swift data series, you can continue on where we left off in video 6 or 7. If you're just joining me, you can download that branch from the GitHub repository from the link in the description. Make sure you choose either the 6th video, the Many-to-Many Relationships, or the 7th video, the App Localization branches. Either one will work. The 7th video is only about localizing the app to German and there are no other code changes. What we want to do in this video is to enable iCloud and CloudKit. CloudKit is a database system in iCloud and Swift data can automatically create a private database in CloudKit to share data between users' devices, but we need to enable it and make some minor code changes. 



Now iCloud services are only available to developers that are members of the Apple Developer Program, so you must register your account with Xcode. Now if you've downloaded this project from my GitHub repository, you must set your own team and your own account and modify your bundle identifier so that there is no duplication with mine. So you can select the app at the top level of the navigation pane and select the target, and select the Signing in Capabilities and it's here that you can change your team and your bundle ID. Once you've done that, you're ready to begin. So make sure you're on that Signing in Capabilities tab for your target and click on the plus capability button at the top and then search for iCloud. Double click on it to add it to your project. Now for some reason this shouldn't happen to you. I'm having a problem with this bundle ID and despite my troubleshooting I couldn't resolve it. But the solution was simply to change my bundle ID. So I'm going to do that here. Now this as a rule could be catastrophic if you had an app in the App Store. But as you'll learn, enabling Cloud Kit should be the first thing that you do in your apps as data already stored in the app will not get transferred to iCloud by default and a different bundle ID is going to mean a different app as far as your users are concerned. 



So copy that bundle ID as we're going to need it. And then in the Services section, click on Cloud Kit. Well, Cloud Kit requires a container on Apple servers to store and manage the database. If the container is not automatically created by Xcode, we have to do it ourselves. And we do that by pressing this plus button. You should start with iCloud, followed by a period, and then followed by your bundle ID which we copied so I'll just paste it in here. Now Xcode will create a new container if the named container doesn't already exist and add it to your app ID and it'll add that new container to your app's entitlement. If you tap the refresh button, the red will turn white or black depending on whether or not you're in light or dark mode. Now push notifications, also known as remote notifications, are messages sent from a server to inform our app that something's changed or needs our attention. Remote notifications posted by Cloud Kit are sent from Apple servers when something changes in that database. This can happen not only when the user is working on the app, but also when the app is running in the background. So we'll need to add background mode capability and enable a service called Remote Notifications to receive these notifications at any time. So we add that capability the same way that we added iCloud capability. Tap on the plus capability button. Search for background modes and double click on it to add it. And then select the Remote Notifications. Your app should now be configured to use Cloud Kit. You can verify this by going to the Apple Developer site and logging in with your credentials. In the Certificates, IDs, and Profiles section, you can click on Identifiers. 



And when there, search for the ID that you've used. You can see that I've had a few tests here, but the one that I just created is this one. If I double click on it, I can scroll down and I'll see that iCloud has been enabled. Then if I scroll further down, I see I also have push notifications. If these aren't set, go back and make sure that you followed the instructions. Before you run your app, however, there are some gotchas, and these are pretty significant. First let's take a look at our models and the book model. All properties of all models must have a value by default or be optional, and we haven't done that. Though we supply default values in our initializer here for the book, for all of our non-optional properties except for the title and author, this is used by our app when we create a new entry. But Cloud Kit won't have this information, so we'll need to supply those same values for our parameters as well as for the other two. The only one we don't need to provide a value for is rating, because it's an optional. So for title and author, I can initialize it with an empty string. For dateAdded, I'll use what we used in the initializer, and that's the static date.now. And I'll follow that practice for the remaining properties. I'll use date.distantPast for the other two dates. And I'll provide an empty string for synopsis. For the status, we'll need to provide the status.onShelves raw value. The second thing that must be true is that all relationships must be optional, and we've done that. You may recall that I mentioned that when we were setting up our relationships, and that is why I did not set them up as an empty array.



 They must be optional. Then the third thing that Cloud Kit can't work with is a unique attribute. And this may be problematic in some of your applications if you want to ensure that some properties are unique. If that's the case, you'll have to do your check in code before you add or update records. In the QuoteModel class, we just need to provide a default value for our text property, so let's make it an empty string. The creationDate already has one, and page is an optional string, so we're good. The relationship is also optional. In genre, it'll need a default value for both the name and color. So I'll initialize the name with an empty string. And for the color, it's a hex representation as a string of a color to use. So let me use red, which is FF0000. Again, books, that relationship is an optional. That's all we need to do to establish Cloud Kit for our apps. Now there's one more big gotcha. Data that was entered before you enabled Cloud Kit will not synchronize with Cloud Kit. So the lesson to be learned is that if you're going to enable Cloud Kit and data sharing between devices, establish Cloud Kit before you release it to the App Store or on test flight. And since we haven't done that, we're OK. To test that your app is working properly, it's advisable that you have two real devices to test on, both logged into the same iCloud account. You can use one test device and a simulator logged into the same account, but push notifications will only go one way, as the simulator can't receive a notification from your phone. I'm fortunate enough to have two devices, one is my real phone and the other is an older iPhone I got from a friend, so I'm going to be testing on these devices. To display both devices on the screen at one time, I'm going to use a fantastic new tool called Bezel. If you ever want to record your devices, I highly recommend this tool, so I'll leave a link in the description. First let me switch my build and run device to this Dev iPhone 11 Pro. And I'm going to run the app on that phone. If I bring up the Bezel screens, I see that both of my devices are connected to my Mac, but on the right you see the My Books app getting installed on the iPhone 11. 



This is a clean install, and on first launch you'll see some console activity, and that's Xcode setting up my Cloud Kit containers. Now this phone has no books yet, so let me enter one. Let me go to the details screen, and I'm going to add some genres. Oh, there are none yet, so let me add some. How about one for fiction, and one for mystery. Let me select these both for this book. Let me also add a comment to see if that works. Back in detail, let me add a synopsis, and who it was recommended by. Let me change the start date. Go back to the main screen, and then back again. And then I'm going to specify that the book is in progress. Well now it's time to test that synchronization. So let me switch my build and run to the iPhone 13 Pro, which is that one on the left. This too is going to be a fresh install, so when I run this app, no books are on this phone yet. Let me run it then and bring back the bezel displays. On first launch, there are no books initially, very quickly, but as soon as the console activity is displaying here, you're showing it's going to iCloud and it's fetching that book. Once it's been fetched, it's displayed. So far so good. So let me create a new book on this phone on the left. Almost immediately, you see the book is synced to the phone on the right. Let me edit that book by going to the details screen then, and I'm going to add a couple of new genre types. How about one for non-fiction? And how about one for romance? So let me just choose fiction and romance as the two genres for this book. And notice, even in the list view on the right, the genre tags are displayed immediately. Moving back then to the phone on the right, let me edit that second book. And if I go to the genre screen, I see that those new genres that I created on the other phone have been created and are available to me here. Let me go back and add a quote here. 



Back on the device on the left-hand side, I don't see any quotes in the list view because I haven't programmed that. But if I go to the details for that book, I can see that I have a quote and I can go to the quote screen and see that quote that I entered. This has all been really nice. Now your success may vary, however, in your apps, and there have been some reports that Cloud Kit syncing with Swift data has some issues. Remember that this is the first year for Swift data, so I personally would be a bit reluctant to release a new app that relies on this iCloud synchronization yet. I just don't think I'd be able to troubleshoot the support requests, as my knowledge of iCloud and Swift data just isn't up to par yet. Before I finish this video, though, it's worth checking out the iCloud database. If you return to the Signing and Capabilities tab of your app, there's a button in the iCloud section that will take you directly to the Cloud Kit console. Once you're there, you can click on the Cloud Kit database link. And then the drop-down link will list all of your active Cloud Kit containers. So select the one for your app, which in my case is this one. I find that I get this error sometimes when I'm here. However, I find that if I just switch to another one and then back again, it fixes itself. Now Swift data will only store in a private database, so you'll never be able to see the records of other users who use your app. 



Their data is all stored privately in their iCloud accounts. You will, however, be able to see the records that you created, as this is associated with your Apple ID and that's who you're logged in as. So select the private database. And then if you select Record Types, you'll see in addition to the two default tables, there are tables for your book, genre, and quote models. All are prefaced with a CD underscore. Next select the zone to be the Cloud Kit zone. Then select the book table, and let's see if we can view all of the records that we created. Well, if you tap the Query Records button, this should display all records, but you get this Record Name is not marked queryable error. And this is because the Cloud Kit dashboard is trying to sort the objects by the Record Name field. And this is a field that Cloud Kit added to a record type to identify the records. In order to sort though, there needs to be an index associated with that field, and there isn't one. To create an index, select the indexes in the Schema section. Select the Books table. And then at the bottom, tap the plus button to add a basic index. Locate and select the Record Name. And then click on Save Changes. We can return to the Records section by selecting the Private Database, the iCloud zone, and then the Books database table, and I'll still see that error. However, when I click on the Query Records again, both books that I created are displayed. So let me select the first book and open it to view the record details on the right. And here I can even edit things like this rating. So let me change it to a 3 and save the changes. If I just return to my device screens in Bezel now and unlock them, you'll see as soon as the one on the right comes to the forefront, the stars are displayed. Now I know I set the rating to 3 and it's showing 2 stars, but that's how that ratings view is coded. 



And since you only set ratings in the app, it's not really an issue. I tap on 2 stars and it sets the rating to 3, but only displays 2 stars. I might go back and update that code for that control and fix it up so that it corresponds to the actual numbers stored. Anyway, that doesn't really matter for this video. Now up until now, your Cloud Kit is using a development environment for storing your records. Before you release your app to the App Store, you need to deploy it to production. Now this won't transfer over the records at all by default. And there are some other options on the left-hand side that will allow you to reset or export the schema while in development. This may be handy. Now I'm definitely not a Cloud Kit expert, so if you want to be able to transfer records from the development over to the production environment, then you'll have to do some research. But remember that currently you're the only one testing here and that's just test data, so it shouldn't really matter. To deploy to production, you click on the Deploy Schema Changes and it'll open a window that displays the features that are going to be transferred to the production environment. This does include all the record types and the indices. If you agree, you can click on the Deploy button to complete the process and your app is ready for distribution and submission to the App Store. Well, I hope you've enjoyed this 8-part series on SwiftData. I've had a lot of fun putting this together and I've tried to make it as comprehensive as possible. But there's probably a lot more things that you can do with SwiftData that I haven't touched on. And perhaps throughout the year, as I create more videos, I'll be able to expand on this series. So leave me a comment in the description and tap the thumbs up button if you enjoyed this video. Thanks. Bye. Bye. Bye. you